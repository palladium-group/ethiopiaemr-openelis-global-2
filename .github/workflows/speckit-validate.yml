name: SpecKit Validation
on:
  pull_request:
    # Run on PRs to any branch when SpecKit files change
    paths:
      - '.specify/**'
      - '.cursor/**'
      - '.claude/**'
      - 'scripts/install-speckit-commands.py'
  push:
    branches: [develop]
    paths:
      - '.specify/**'
      - 'scripts/install-speckit-commands.py'
  workflow_dispatch:

jobs:
  validate-speckit-commands:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Compile SpecKit commands
        run: python scripts/install-speckit-commands.py -y all

      - name: Verify all commands exist
        run: |
          EXPECTED_COMMANDS="speckit.analyze speckit.checklist speckit.clarify speckit.constitution speckit.implement speckit.plan speckit.specify speckit.tasks speckit.taskstoissues"
          for cmd in $EXPECTED_COMMANDS; do
            if [ ! -f ".cursor/commands/${cmd}.md" ]; then
              echo "ERROR: Missing .cursor/commands/${cmd}.md"
              exit 1
            fi
            if [ ! -f ".claude/commands/${cmd}.md" ]; then
              echo "ERROR: Missing .claude/commands/${cmd}.md"
              exit 1
            fi
          done
          echo "✓ All 9 commands compiled for both agents"

      - name: Verify no invalid path patterns
        run: |
          # Check for double-rewrite bugs (e.g., .specify/.specify/)
          if grep -r '\.specify/\.specify/' .cursor/commands/ .claude/commands/ 2>/dev/null; then
            echo "ERROR: Found invalid '.specify/.specify/' paths in compiled commands"
            exit 1
          fi
          # Check that paths use .specify/ prefix (not bare templates/ or scripts/)
          # Use grep -q to properly handle exit codes when grep -v filters all matches
          if grep -E '(^|[^.])templates/' .cursor/commands/ .claude/commands/ 2>/dev/null | grep -v '\.specify/templates/' | grep -q .; then
            echo "ERROR: Found bare 'templates/' paths (should be '.specify/templates/')"
            exit 1
          fi
          echo "✓ All paths correctly formatted"

      - name: Summary
        run: |
          echo "## SpecKit Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Commands compiled:** 9" >> $GITHUB_STEP_SUMMARY
          echo "- **Target agents:** Cursor, Claude Code" >> $GITHUB_STEP_SUMMARY
          echo "- **Path validation:** Passed" >> $GITHUB_STEP_SUMMARY
