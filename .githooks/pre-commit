#!/bin/bash
# Auto-format hook: Runs formatters on staged files before commit
# This prevents CI failures from formatting issues

set -e

echo "ðŸŽ¨ Running auto-formatters on staged files..."

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo "  â†’ No staged files to format"
    exit 0
fi

# Track if we formatted anything
FORMATTED=false

# Format Java files (Maven Spotless on specific files)
JAVA_FILES=$(echo "$STAGED_FILES" | grep '\.java$' || true)
if [ -n "$JAVA_FILES" ]; then
    echo "  â†’ Formatting $(echo "$JAVA_FILES" | wc -l) Java file(s) (spotless)..."
    # Spotless applies to entire project, but we only re-stage modified files
    mvn spotless:apply -q 2>/dev/null || true
    FORMATTED=true
fi

# Format frontend files (Prettier on specific files)
FRONTEND_FILES=$(echo "$STAGED_FILES" | grep -E 'frontend/.*\.(js|jsx|ts|tsx|css|scss)$' || true)
if [ -n "$FRONTEND_FILES" ]; then
    echo "  â†’ Formatting $(echo "$FRONTEND_FILES" | wc -l) frontend file(s) (prettier)..."
    # Format only staged frontend files
    echo "$FRONTEND_FILES" | while IFS= read -r file; do
        if [ -f "$file" ]; then
            (cd frontend && npx prettier --write "../$file" --silent 2>/dev/null) || true
        fi
    done
    FORMATTED=true
fi

# Format Python files (Ruff on specific files)
PYTHON_FILES=$(echo "$STAGED_FILES" | grep -E 'projects/catalyst/.*\.py$' || true)
if [ -n "$PYTHON_FILES" ]; then
    echo "  â†’ Formatting $(echo "$PYTHON_FILES" | wc -l) Python file(s) (ruff)..."
    # Format only staged Python files
    echo "$PYTHON_FILES" | while IFS= read -r file; do
        if [ -f "$file" ]; then
            # Determine which catalyst project this file belongs to
            if echo "$file" | grep -q 'catalyst-agents'; then
                (cd projects/catalyst/catalyst-agents && uv run ruff format "../../$file" 2>/dev/null) || true
            elif echo "$file" | grep -q 'catalyst-gateway'; then
                (cd projects/catalyst/catalyst-gateway && uv run ruff format "../../$file" 2>/dev/null) || true
            elif echo "$file" | grep -q 'catalyst-mcp'; then
                (cd projects/catalyst/catalyst-mcp && uv run ruff format "../../$file" 2>/dev/null) || true
            fi
        fi
    done
    FORMATTED=true
fi

# Re-stage all files that were formatted
if [ "$FORMATTED" = true ]; then
    echo "  â†’ Re-staging formatted files..."
    echo "$STAGED_FILES" | while IFS= read -r file; do
        if [ -f "$file" ]; then
            git add "$file"
        fi
    done
fi

# Lint Python files (Ruff check) â€” same checks as Catalyst CI
if [ -n "$PYTHON_FILES" ]; then
    echo "  â†’ Linting staged Python file(s) (ruff check)..."
    for project in catalyst-agents catalyst-gateway catalyst-mcp; do
        PROJECT_FILES=$(echo "$PYTHON_FILES" | grep "projects/catalyst/$project/" || true)
        if [ -n "$PROJECT_FILES" ]; then
            REL_PATHS=()
            while IFS= read -r file; do
                # Strip the project prefix to get the path relative to projects/catalyst/$project
                rel_path=${file#"projects/catalyst/$project/"}
                REL_PATHS+=("$rel_path")
            done <<< "$PROJECT_FILES"
            if (cd "projects/catalyst/$project" && uv run ruff check "${REL_PATHS[@]}" --fix); then
                : # lint passed
            else
                echo "âŒ Ruff check failed in projects/catalyst/$project. Fix lint errors before committing."
                exit 1
            fi
            # Ruff may have modified files; re-stage them so the commit matches the linted content
            echo "$PROJECT_FILES" | while IFS= read -r file; do
                if [ -f "$file" ]; then
                    git add "$file"
                fi
            done
        fi
    done
fi

echo "âœ… Formatting complete!"
exit 0
