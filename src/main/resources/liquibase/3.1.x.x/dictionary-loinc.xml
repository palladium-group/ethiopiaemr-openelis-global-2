<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <!-- STEP 1: Add LOINC columns -->
    <changeSet id="add-loinc-columns-to-dictionary" author="agaba-derrick">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="dictionary" schemaName="clinlims"/>
            <not>
                <columnExists tableName="dictionary" columnName="loinc_code" schemaName="clinlims"/>
            </not>
        </preConditions>
        <addColumn tableName="dictionary" schemaName="clinlims">
            <column name="loinc_code" type="varchar(20)"/>
            <column name="loinc_display" type="varchar(100)"/>
            <column name="loinc_system" type="varchar(255)" defaultValue="http://loinc.org"/>
        </addColumn>
    </changeSet>

    <!-- STEP 2: Populate values -->
    <changeSet id="populate-loinc-values" author="agaba-derrick">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="dictionary" columnName="loinc_code" schemaName="clinlims"/>
        </preConditions>

        <!-- Ensure dict_entry rows exist -->
        <update tableName="dictionary" schemaName="clinlims">
            <column name="loinc_code" value="LA13522-5"/>
            <column name="loinc_display" value="Invalid Result"/>
            <where>dict_entry = 'Invalid'</where>
        </update>

        <update tableName="dictionary" schemaName="clinlims">
            <column name="loinc_code" value="LA9663-1"/>
            <column name="loinc_display" value="Detected"/>
            <where>dict_entry = 'Positive'</where>
        </update>

        <update tableName="dictionary" schemaName="clinlims">
            <column name="loinc_code" value="LA9664-9"/>
            <column name="loinc_display" value="Not Detected"/>
            <where>dict_entry = 'Negative'</where>
        </update>

        <!-- Only insert if missing -->
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM clinlims.dictionary WHERE dict_entry = 'Indeterminate'
            </sqlCheck>
        </preConditions>
        <insert tableName="dictionary" schemaName="clinlims">
            <column name="id" valueComputed="nextval('dictionary_seq')"/>
            <column name="dict_entry" value="Indeterminate"/>
            <column name="is_active" value="Y"/>
            <column name="loinc_code" value="LA12688-0"/>
            <column name="loinc_display" value="Indeterminate Result"/>
            <column name="loinc_system" value="http://loinc.org"/>
        </insert>
    </changeSet>
</databaseChangeLog>
