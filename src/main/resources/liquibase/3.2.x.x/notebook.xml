<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <!-- ======================================================== -->
    <!-- NOTEBOOK TABLE -->
    <!-- ======================================================== -->
    <property name="now" value="now()" dbms="postgresql"/>
    <changeSet id="create-notebook-table" author="mozzymutesa">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="notebook" schemaName="clinlims" />
            </not>
        </preConditions>
        <comment>Creating the main NOTEBOOK table to store experiment notebooks.</comment>
        <createTable tableName="notebook">
            <column name="id" type="INTEGER" valueSequenceNext="notebook_seq">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_notebook"/>
            </column>
            <column name="title" type="VARCHAR(255)"/>
            <column name="type" type="VARCHAR(255)"/>
            <column name="project" type="VARCHAR(255)"/>
            <column name="objective" type="VARCHAR(255)"/>
            <column name="protocol" type="VARCHAR(255)"/>
            <column name="content" type="TEXT"/>
             <column name="status" type="VARCHAR(255)"/>
            <column name="technician_id" type="NUMERIC(10)">
                <constraints nullable="true" foreignKeyName="fk_notebook_technician"
                             referencedTableName="system_user" referencedColumnNames="id"/>
            </column>
            <column name="patient_id" type="NUMERIC(10)">
                <constraints nullable="true" foreignKeyName="fk_notebook_patient"
                             referencedTableName="patient" referencedColumnNames="id"/>
            </column>
            <column name="last_updated" type="datetime" valueComputed="${now}" />
            <column name="date_created" type="datetime" valueComputed="${now}" />
        </createTable>
        <createSequence sequenceName="notebook_seq" startValue="1" incrementBy="1"/>
    </changeSet>
    <!-- ======================================================== -->
    <!-- NOTEBOOK_PAGE TABLE -->
    <!-- ======================================================== -->
    <changeSet id="create-notebook-page-table" author="mozzymutesa">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="notebook_page" schemaName="clinlims" />
            </not>
        </preConditions>
        <comment>Creating NOTEBOOK_PAGE table to store individual pages within a notebook.</comment>
        <createTable tableName="notebook_page">
            <column name="id" type="INTEGER" valueSequenceNext="notebook_page_seq">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_notebook_page"/>
            </column>
            <column name="title" type="VARCHAR(255)"/>
             <column name="last_updated" type="datetime" valueComputed="${now}" />
            <column name="instructions" type="TEXT"/>
            <column name="content" type="TEXT"/>
            <column name="notebook_id" type="INTEGER">
                <constraints nullable="false" foreignKeyName="fk_page_notebook"
                             referencedTableName="notebook" referencedColumnNames="id"/>
            </column>
        </createTable>

        <createSequence sequenceName="notebook_page_seq" startValue="1" incrementBy="1"/>
    </changeSet>

    <!-- ======================================================== -->
    <!-- NOTEBOOK_FILE TABLE -->
    <!-- ======================================================== -->
    <changeSet id="create-notebook-file-table" author="mozzymutesa">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="notebook_file" schemaName="clinlims" />
            </not>
        </preConditions>
        <comment>Creating NOTEBOOK_FILE table to store binary file attachments related to a notebook.</comment>
        <createTable tableName="notebook_file">
            <column name="id" type="INTEGER" valueSequenceNext="notebook_file_seq">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_notebook_file"/>
            </column>
            <column name="file_data" type="bytea"/>
            <column name="file_type" type="VARCHAR(255)"/>
             <column name="last_updated" type="datetime" valueComputed="${now}" />
            <column name="notebook_id" type="INTEGER">
                <constraints nullable="false" foreignKeyName="fk_file_notebook"
                             referencedTableName="notebook" referencedColumnNames="id"/>
            </column>
        </createTable>

        <createSequence sequenceName="notebook_file_seq" startValue="1" incrementBy="1"/>
    </changeSet>

    <!-- ======================================================== -->
    <!-- NOTEBOOK_TAGS TABLE -->
    <!-- ======================================================== -->
    <changeSet id="create-notebook-tags-table" author="mozzymutesa">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="notebook_tags" schemaName="clinlims" />
            </not>
        </preConditions>
        <comment>Creating NOTEBOOK_TAGS table to store tags (as an element collection) associated with each notebook.</comment>
        <createTable tableName="notebook_tags">
            <column name="notebook_id" type="INTEGER">
                <constraints nullable="false" foreignKeyName="fk_tags_notebook"
                             referencedTableName="notebook" referencedColumnNames="id"/>
            </column>
            <column name="tag" type="VARCHAR(255)"/>
        </createTable>
    </changeSet>

    <!-- ======================================================== -->
    <!-- NOTEBOOK_SAMPLES TABLE -->
    <!-- ======================================================== -->
    <changeSet id="create-notebook-samples-table" author="mozzymutesa">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="notebook_samples" schemaName="clinlims" />
            </not>
        </preConditions>
        <comment>Creating NOTEBOOK_SAMPLES join table linking notebooks to SampleItem entities.</comment>
        <createTable tableName="notebook_samples">
            <column name="notebook_id" type="INTEGER">
                <constraints nullable="false" foreignKeyName="fk_samples_notebook"
                             referencedTableName="notebook" referencedColumnNames="id"/>
            </column>
            <column name="sample_item_id" type="INTEGER">
                <constraints nullable="false" foreignKeyName="fk_samples_sampleitem"
                             referencedTableName="sample_item" referencedColumnNames="id"/>
            </column>
        </createTable>
    </changeSet>

    <!-- ======================================================== -->
    <!-- NOTEBOOK_ANALYSERS TABLE -->
    <!-- ======================================================== -->
    <changeSet id="create-notebook-analysers-table" author="mozzymutesa">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="notebook_analysers" schemaName="clinlims" />
            </not>
        </preConditions>
        <comment>Creating NOTEBOOK_ANALYSERS join table linking notebooks to Analyzer entities.</comment>
        <createTable tableName="notebook_analysers">
            <column name="notebook_id" type="INTEGER">
                <constraints nullable="false" foreignKeyName="fk_analysers_notebook"
                             referencedTableName="notebook" referencedColumnNames="id"/>
            </column>
            <column name="analyser_id" type="INTEGER">
                <constraints nullable="false" foreignKeyName="fk_analysers_analyser"
                             referencedTableName="analyzer" referencedColumnNames="id"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="mozzymutesa" id="create-notebook-menu-option">
        <preConditions>
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM clinlims.menu WHERE element_id = 'menu_notebook'
            </sqlCheck>
        </preConditions>
        <comment>insert NoteBook tab menu option</comment>
        <insert tableName="menu" schemaName="clinlims">
            <column name="id" valueSequenceNext="menu_seq" />
            <column name="presentation_order" value="8" />
            <column name="element_id" value="menu_notebook" />
            <column name="display_key" value="sidenav.label.notebook"  />
            <column name="tool_tip_key" value="sidenav.label.notebook.tooltip" />
            <column name="new_window" valueBoolean="false" />
            <column name="is_active" valueBoolean="true" />
            <column name="action_url" value="/NotebookDashboard" />
        </insert>
    </changeSet>
     <changeSet author="mozzymutesa" id="add-notebook-expt-type-category">
    <preConditions onFail="MARK_RAN">
      <sqlCheck expectedResult="0">select count(*) from clinlims.dictionary_category where name = 'notebook_experiment_type';
            </sqlCheck>
    </preConditions>
    <comment>adds notebook_experiment_typee dictionary Category in dictionary_category table</comment>
        <insert tableName="dictionary_category" schemaName="clinlims">
            <column name="id" valueSequenceNext="dictionary_category_seq" />
            <column name="description" value="NoteBook Experiment Type" />
            <column name="lastupdated" valueComputed="${now}"/>
            <column name="local_abbrev" value="NoteExpTyp" />
            <column name="name" value="notebook_experiment_type" />
        </insert>
    </changeSet>
</databaseChangeLog>
