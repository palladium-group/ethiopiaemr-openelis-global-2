<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <!-- ======================================================== -->
    <!-- NOTEBOOK TABLE -->
    <!-- ======================================================== -->
    <property name="now" value="now()" dbms="postgresql"/>
    <changeSet id="create-notebook-table" author="mozzymutesa">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="notebook" schemaName="clinlims" />
            </not>
        </preConditions>
        <comment>Creating the main NOTEBOOK table to store experiment notebooks.</comment>
        <createTable tableName="notebook">
            <column name="id" type="INTEGER" valueSequenceNext="notebook_seq">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_notebook"/>
            </column>
            <column name="title" type="VARCHAR(255)"/>
            <column name="type" type="VARCHAR(255)"/>
            <column name="project" type="VARCHAR(255)"/>
            <column name="objective" type="VARCHAR(255)"/>
            <column name="protocol" type="VARCHAR(255)"/>
            <column name="content" type="TEXT"/>
             <column name="last_updated" type="datetime"/>
        </createTable>
        <createSequence sequenceName="notebook_seq" startValue="1" incrementBy="1"/>
    </changeSet>
    <!-- ======================================================== -->
    <!-- NOTEBOOK_PAGE TABLE -->
    <!-- ======================================================== -->
    <changeSet id="create-notebook-page-table" author="mozzymutesa">
        <comment>Creating NOTEBOOK_PAGE table to store individual pages within a notebook.</comment>

        <createTable tableName="notebook_page">
            <column name="id" type="INTEGER" valueSequenceNext="notebook_page_seq">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_notebook_page"/>
            </column>
            <column name="title" type="VARCHAR(255)"/>
            <column name="instructions" type="CLOB"/>
            <column name="content" type="CLOB"/>
            <column name="notebook_id" type="INTEGER">
                <constraints nullable="false" foreignKeyName="fk_page_notebook"
                             referencedTableName="notebook" referencedColumnNames="id"/>
            </column>
        </createTable>

        <createSequence sequenceName="notebook_page_seq" startValue="1" incrementBy="1"/>
    </changeSet>

    <!-- ======================================================== -->
    <!-- NOTEBOOK_FILE TABLE -->
    <!-- ======================================================== -->
    <changeSet id="create-notebook-file-table" author="mozzymutesa">
        <comment>Creating NOTEBOOK_FILE table to store binary file attachments related to a notebook.</comment>

        <createTable tableName="notebook_file">
            <column name="id" type="INTEGER" valueSequenceNext="notebook_file_seq">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_notebook_file"/>
            </column>
            <column name="file_data" type="BLOB"/>
            <column name="file_type" type="VARCHAR(255)"/>
            <column name="notebook_id" type="INTEGER">
                <constraints nullable="false" foreignKeyName="fk_file_notebook"
                             referencedTableName="notebook" referencedColumnNames="id"/>
            </column>
        </createTable>

        <createSequence sequenceName="notebook_file_seq" startValue="1" incrementBy="1"/>
    </changeSet>

    <!-- ======================================================== -->
    <!-- NOTEBOOK_TAGS TABLE -->
    <!-- ======================================================== -->
    <changeSet id="create-notebook-tags-table" author="mozzymutesa">
        <comment>Creating NOTEBOOK_TAGS table to store tags (as an element collection) associated with each notebook.</comment>

        <createTable tableName="notebook_tags">
            <column name="notebook_id" type="INTEGER">
                <constraints nullable="false" foreignKeyName="fk_tags_notebook"
                             referencedTableName="notebook" referencedColumnNames="id"/>
            </column>
            <column name="tag" type="VARCHAR(255)"/>
        </createTable>
    </changeSet>

    <!-- ======================================================== -->
    <!-- NOTEBOOK_SAMPLES TABLE -->
    <!-- ======================================================== -->
    <changeSet id="create-notebook-samples-table" author="mozzymutesa">
        <comment>Creating NOTEBOOK_SAMPLES join table linking notebooks to SampleItem entities.</comment>

        <createTable tableName="notebook_samples">
            <column name="notebook_id" type="INTEGER">
                <constraints nullable="false" foreignKeyName="fk_samples_notebook"
                             referencedTableName="notebook" referencedColumnNames="id"/>
            </column>
            <column name="sample_item_id" type="INTEGER">
                <constraints nullable="false" foreignKeyName="fk_samples_sampleitem"
                             referencedTableName="sample_item" referencedColumnNames="id"/>
            </column>
        </createTable>
    </changeSet>

    <!-- ======================================================== -->
    <!-- NOTEBOOK_ANALYSERS TABLE -->
    <!-- ======================================================== -->
    <changeSet id="create-notebook-analysers-table" author="mozzymutesa">
        <comment>Creating NOTEBOOK_ANALYSERS join table linking notebooks to Analyzer entities.</comment>

        <createTable tableName="notebook_analysers">
            <column name="notebook_id" type="INTEGER">
                <constraints nullable="false" foreignKeyName="fk_analysers_notebook"
                             referencedTableName="notebook" referencedColumnNames="id"/>
            </column>
            <column name="analyser_id" type="INTEGER">
                <constraints nullable="false" foreignKeyName="fk_analysers_analyser"
                             referencedTableName="analyzer" referencedColumnNames="id"/>
            </column>
        </createTable>
    </changeSet>
</databaseChangeLog>
