<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <!-- Core field and mapping tables for the analyzer data model -->

    <!-- analyzer_field: codes/measurements emitted by an analyzer -->
    <changeSet id="011-003-01-create-analyzer-field-table" author="madagascar-analyzer-integration">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="analyzer_field"/>
            </not>
        </preConditions>
        <comment>Create analyzer_field table with custom_field_type FK baked in</comment>
        <createTable tableName="analyzer_field">
            <column name="id" type="VARCHAR(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="analyzer_id" type="NUMERIC(10,0)">
                <constraints nullable="false"
                    foreignKeyName="fk_analyzer_field_analyzer"
                    references="analyzer(id)"/>
            </column>
            <column name="field_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="astm_ref" type="VARCHAR(50)"/>
            <column name="field_type" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="unit" type="VARCHAR(50)"/>
            <column name="custom_field_type_id" type="VARCHAR(36)">
                <constraints foreignKeyName="fk_analyzer_field_custom_type"
                    references="custom_field_type(id)"/>
            </column>
            <column name="is_active" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="sys_user_id" type="VARCHAR(36)"/>
            <column name="last_updated" type="TIMESTAMP" defaultValueComputed="NOW()">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <sql>
            ALTER TABLE clinlims.analyzer_field
            ADD CONSTRAINT chk_field_type
            CHECK (field_type IN ('NUMERIC', 'QUALITATIVE', 'CONTROL_TEST', 'MELTING_POINT', 'DATE_TIME', 'TEXT', 'CUSTOM'));
        </sql>
        <rollback>
            <dropTable tableName="analyzer_field"/>
        </rollback>
    </changeSet>

    <!-- analyzer_field_mapping: maps analyzer fields to OpenELIS concepts -->
    <changeSet id="011-003-02-create-analyzer-field-mapping-table" author="madagascar-analyzer-integration">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="analyzer_field_mapping"/>
            </not>
        </preConditions>
        <comment>Create analyzer_field_mapping table with version and denormalized analyzer_id</comment>
        <createTable tableName="analyzer_field_mapping">
            <column name="id" type="VARCHAR(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="analyzer_field_id" type="VARCHAR(36)">
                <constraints nullable="false"
                    foreignKeyName="fk_field_mapping_analyzer_field"
                    references="analyzer_field(id)"/>
            </column>
            <column name="analyzer_id" type="NUMERIC(10,0)">
                <constraints nullable="false"
                    foreignKeyName="fk_field_mapping_analyzer"
                    references="analyzer(id)"
                    deleteCascade="true"/>
            </column>
            <column name="openelis_field_id" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
            <column name="openelis_field_type" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="mapping_type" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="is_required" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="is_active" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="specimen_type_constraint" type="VARCHAR(255)"/>
            <column name="panel_constraint" type="VARCHAR(255)"/>
            <column name="version" type="INTEGER" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="sys_user_id" type="VARCHAR(36)"/>
            <column name="last_updated" type="TIMESTAMP" defaultValueComputed="NOW()">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <sql>
            ALTER TABLE clinlims.analyzer_field_mapping
            ADD CONSTRAINT chk_openelis_field_type
            CHECK (openelis_field_type IN ('TEST', 'PANEL', 'RESULT', 'ORDER', 'SAMPLE', 'QC', 'METADATA', 'UNIT'));
        </sql>
        <sql>
            ALTER TABLE clinlims.analyzer_field_mapping
            ADD CONSTRAINT chk_mapping_type
            CHECK (mapping_type IN ('TEST_LEVEL', 'RESULT_LEVEL', 'METADATA'));
        </sql>
        <rollback>
            <dropTable tableName="analyzer_field_mapping"/>
        </rollback>
    </changeSet>

</databaseChangeLog>
